<p-toast></p-toast>

<div class="flex flex-col h-[calc(100vh-6rem)]">
  <p-table
    #dt2
    [value]="subjects"
    [scrollable]="true"
    scrollHeight="flex"
    dataKey="_id"
    [rows]="10"
    [paginator]="true"
    [rowsPerPageOptions]="[10, 25, 50]"
    class="flex-1 text-sm"
    [globalFilterFields]="['name', 'subject', 'subjectList']"
    [tableStyle]="{ 'min-width': '65rem', radous: '16px' }"
  >
    <!-- Caption / Global Search -->
    <ng-template pTemplate="caption">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <p class="text-xl font-semibold text-gray-800">Manage Subjects</p>
          <p-select
            [appendTo]="'body'"
            [filter]="true"
            [(ngModel)]="selectedClass"
            name=""
            [options]="classNames"
            optionLabel="label"
            [showClear]="true"
            optionValue="value"
            placeholder="Select Class"
            class="w-56"
            (onChange)="onClassChange($event)"
          >
          </p-select>
        </div>
        <div class="flex items-center gap-3">
          <p-button
            label="Add New Subject"
            icon="pi pi-plus"
            (onClick)="showAddDialog()"
          />
          <p-iconfield iconPosition="left" class="ml-auto">
            <p-inputicon>
              <i class="pi pi-search"></i>
            </p-inputicon>
            <input
              pInputText
              type="text"
              placeholder="Search by grade, year or teacher"
              (input)="dt2.filterGlobal($event.target.value, 'contains')"
            />
          </p-iconfield>
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="header">
      <tr>
        <th>Subject Name</th>
        <th>Subject Code</th>
        <th>Class</th>
        <th>Subject Teacher</th>
        <th>Actions</th>
      </tr>
    </ng-template>

    <!-- Body -->
    <ng-template pTemplate="body" let-subject>
      <tr>
        <td>{{ subject.name }}</td>
        <td>{{ subject.code }}</td>
        <td>{{ subject.classroom?.name }}</td>
        <td>{{ subject.teacher?.name || subject.teacher?.fname }}</td>
        <td>
          <div class="flex gap-2">
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              class="p-button-sm p-button-info"
              pTooltip="Edit Subject"
              tooltipPosition="top"
              (click)="editSubject(subject)"
            ></button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-sm p-button-danger"
              pTooltip="Delete Subject"
              tooltipPosition="top"
              (click)="deleteSubject(subject)"
            ></button>
          </div>
        </td>
      </tr>
    </ng-template>

    <!-- Empty -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="7">No Subjects found.</td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Dialog: Add/Edit Class -->
  <p-dialog
    header="{{ editing ? 'Edit Subject' : 'Add New Subject' }}"
    [(visible)]="displayDialog"
    [modal]="true"
    [dismissableMask]="false"
    [closeOnEscape]="false"
    [blockScroll]="true"
    [style]="{ width: '40vw', maxHeight: '90vh' }"
  >
    <app-create-subject
      [subject]="editing"
      [isEditMode]="editing"
      (saved)="loadSubjects()"
      (close)="displayDialog = false"
    ></app-create-subject>
  </p-dialog>
  <p-confirmdialog />
</div>
