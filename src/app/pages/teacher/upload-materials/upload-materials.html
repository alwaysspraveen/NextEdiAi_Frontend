<p-toast></p-toast>

<!-- App shell -->
<div class="flex flex-col gap-2 h-[calc(100vh-4rem)] ">
  <p-toolbar class="topbar shrink-0 sticky top-0 z-10 shadow-sm">
    <ng-template pTemplate="start">
      <div class="brand flex items-center gap-2 font-semibold text-slate-900">
        <i class="pi pi-bolt text-sky-500"></i>
        <span>NoteGPT</span>
      </div>
    </ng-template>
    <ng-template pTemplate="end">
      <p-tag severity="secondary" [value]="materialIdBadge"></p-tag>
    </ng-template>
  </p-toolbar>

  <div class="flex-1 min-h-0 text-sm" >
    <div class="h-full min-h-0 grid grid-cols-[460px_minmax(0,1fr)] gap-2">
      <!-- LEFT: Upload panel (fixed width) -->
      <div class="min-h-0">
        <p-card
          header="Upload material"
          [subheader]="'PDF / DOCX'"
          [styleClass]="'h-full flex flex-col overflow-auto'"
        >
          <div class="flex flex-col gap-2 mb-3">
            <label class="text-sm text-slate-600">Select Class</label>
            <p-select
              [options]="classNames"
              [(ngModel)]="classId"
              optionLabel="label"
              optionValue="value"
              placeholder="Select Class"
              class="w-full"
              (ngModelChange)="onClassChange($event)"
            />
          </div>
          <div class="flex flex-col gap-2 mb-3">
            <label class="text-sm text-slate-600">Select Subject</label>
            <p-select
              [options]="subjectNames"
              [(ngModel)]="subjectId"
              (ngModelChange)="onSubjectChange()"
              optionLabel="label"
              optionValue="value"
              placeholder="Select Subject"
              class="w-full"
            />
          </div>
          <div class="flex flex-col gap-2 mb-3">
            <label class="text-sm text-slate-600">Title</label>
            <input
              pInputText
              [(ngModel)]="materialId"
              placeholder="e.g. MATH-CH1-2025"
              class="w-full"
            />
          </div>

          <p-fileUpload
            #uploader
            mode="advanced"
            name="file"
            [customUpload]="true"
            (uploadHandler)="onCustomUpload($event)"
            [auto]="false"
            [showCancelButton]="true"
            [showUploadButton]="true"
            [multiple]="false"
            [maxFileSize]="60_000_000"
            chooseLabel="Choose"
            uploadLabel="Upload & Index"
            cancelLabel="Clear"
            accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
            [disabled]="uploading"
            [styleClass]="'w-full'"
          ></p-fileUpload>

          <p-divider class="my-4"></p-divider>
          <small class="text-xs text-slate-500">
            Tip: Already Uploaded? Select <b>Material</b> below and skip upload.
          </small>
          <div class="flex flex-col gap-2 mb-3 mt-2">
            <label class="text-sm text-slate-600">Select Material</label>
            <p-select
              [options]="materialNames"
              [(ngModel)]="materialId"
              optionLabel="label"
              optionValue="value"
              [filter]="true"
              placeholder="Select Material"
              class="w-full"
            />
          </div>

          <div *ngIf="uploadInfo" class="mt-3">
            <div *ngIf="uploadInfo.ok; else upErr">
              <div class="text-emerald-600 mb-2">
                ✅ Indexed chunks: <b>{{ uploadInfo.chunks }}</b>
              </div>
              <div
                *ngIf="uploadInfo.stats"
                class="text-sm text-slate-600 space-y-1"
              >
                <div>Total pages: {{ uploadInfo.stats.totalPages }}</div>
                <div>Pages with text: {{ uploadInfo.stats.pagesWithText }}</div>
                <div *ngIf="uploadInfo.stats.emptyPages?.length">
                  Empty pages ({{ uploadInfo.stats.emptyPages.length }}):
                  <div class="text-xs opacity-80">
                    {{ uploadInfo.stats.emptyPages.join(", ") }}
                  </div>
                </div>
              </div>
            </div>
            <ng-template #upErr>
              <div class="text-rose-600">
                ⚠️ {{ uploadInfo.error || "Upload failed" }}
              </div>
              <div
                *ngIf="uploadInfo.error?.includes('NO_TEXT_EXTRACTED')"
                class="text-xs text-slate-500 mt-1"
              >
                Looks like a scanned PDF (no embedded text). Try an
                OCR/searchable PDF.
              </div>
            </ng-template>
          </div>

          <p-divider class="my-4"></p-divider>
        </p-card>
      </div>

      <!-- RIGHT: Chat area (fills remaining space) -->
      <div
        class="flex flex-col h-full min-h-0 border border-slate-200 rounded-xl bg-white overflow-hidden"
      >
        <!-- Scrollable messages area -->
        <div
          class="flex-1 min-h-0 overflow-y-auto p-4 flex flex-col gap-3"
          #messagesViewport
        >
          <div
            *ngIf="!messages.length && !sending"
            class="m-auto text-center opacity-85 max-w-[520px] text-slate-600"
          >
            <i class="pi pi-comments text-3xl mb-2 block"></i>
            <div class="font-medium">Ask about your material</div>
            <small
              >Upload on the left, then type your question. I’ll answer with
              citations and a Sources line.</small
            >
          </div>

          <!-- Messages -->
          <div
            *ngFor="let m of messages"
            class="max-w-[85%] px-3 py-1 rounded-lg border shadow-sm"
            [ngClass]="[
              m.role === 'user'
                ? 'ml-auto bg-blue-600 text-white border-blue-500'
                : 'mr-auto bg-slate-100 text-slate-900 border-slate-200'
            ]"
          >
            <div [innerHTML]="render(m.content)"></div>
          </div>

          <!-- Typing indicator -->
          <div
            *ngIf="sending"
            class="mr-auto max-w-[85%] px-3 py-2 rounded-2xl border bg-slate-100 text-slate-900 border-slate-200"
          >
            <div class="flex items-center gap-2 text-slate-500">
              <span
                class="w-2 h-2 rounded-full bg-slate-400 animate-bounce"
              ></span>
              <span
                class="w-2 h-2 rounded-full bg-slate-400 animate-bounce"
                style="animation-delay: 0.15s"
              ></span>
              <span
                class="w-2 h-2 rounded-full bg-slate-400 animate-bounce"
                style="animation-delay: 0.3s"
              ></span>
            </div>
          </div>
        </div>

        <!-- Composer -->
        <div class="shrink-0 border-t border-slate-200 p-3 bg-slate-50">
          <div class="flex items-end gap-2">
            <textarea
              pInputTextarea
              autoResize="true"
              [(ngModel)]="input"
              (keydown)="onComposerKeydown($event)"
              rows="1"
              placeholder="Ask a question about the uploaded material…"
              class="flex-1 resize-none max-h-48 min-h-[44px] bg-white text-slate-900 border border-slate-300 rounded-lg p-2"
            ></textarea>
            <div class="flex gap-2">
              <button
                pButton
                label="Clear"
                class="p-button-text"
                (click)="clearChat()"
                [disabled]="!messages.length || sending"
              ></button>
              <button
                pButton
                label="Send"
                icon="pi pi-send"
                (click)="send()"
                [disabled]="sending || !input.trim()"
              ></button>
            </div>
          </div>
        </div>
      </div>
      <!-- /chat -->
    </div>
  </div>
</div>
