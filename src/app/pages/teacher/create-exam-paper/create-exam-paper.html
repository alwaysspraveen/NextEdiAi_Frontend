<p-toast></p-toast>

<!-- Shell -->
<div class="flex flex-col gap-2 h-[calc(100vh-4rem)]">
  <p-toolbar class="topbar shrink-0 sticky top-0 z-10 shadow-sm">
    <ng-template pTemplate="start">
      <div class="flex items-center gap-2 font-semibold text-slate-900">
        <i class="pi pi-file-edit text-sky-500"></i>
        <span>Create Exam Paper</span>
      </div>
    </ng-template>
  </p-toolbar>

  <!-- Content -->
  <div class="flex-1 min-h-0 text-sm">
    <div class="h-full min-h-0 grid grid-cols-[560px_minmax(0,1fr)] gap-3">
      <!-- LEFT: Exam form -->
      <div class="min-h-0">
        <p-card
          header="Exam details"
          [subheader]="'Plan or upload your paper'"
          [styleClass]="'h-full flex flex-col overflow-auto'"
        >
          <!-- class / subject -->
          <div class="grid grid-cols-2 gap-3">
            <div class="flex flex-col gap-2">
              <label class="text-sm text-slate-600">Class</label>
              <p-select
                [options]="classNames"
                [(ngModel)]="classId"
                optionLabel="label"
                optionValue="value"
                placeholder="Select Class"
                class="w-full"
                (ngModelChange)="onClassChange($event)"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm text-slate-600">Subject</label>
              <p-select
                [options]="subjectNames"
                [(ngModel)]="subjectId"
                optionLabel="label"
                optionValue="value"
                placeholder="Select Subject"
                class="w-full"
              />
            </div>
          </div>

          <p-divider></p-divider>

          <!-- basics -->
          <div class="grid grid-cols-2 gap-3">
            <div class="flex flex-col gap-2">
              <label class="text-sm text-slate-600">Title</label>
              <input
                pInputText
                [(ngModel)]="title"
                placeholder="e.g. Midterm Algebra"
                class="w-full"
              />
            </div>

            <div class="flex flex-col gap-2">
              <label class="text-sm text-slate-600">Exam Type</label>
              <p-select
                [options]="examTypes"
                [(ngModel)]="examType"
                optionLabel="label"
                optionValue="value"
                placeholder="Select Type"
                class="w-full"
              />
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div class="flex flex-col gap-2">
              <label class="text-sm text-slate-600">Mode</label>
              <p-select
                [options]="modes"
                [(ngModel)]="mode"
                optionLabel="label"
                optionValue="value"
                placeholder="Select Mode"
                class="w-full"
              />
            </div>

            <div class="flex flex-col gap-2">
              <label class="text-sm text-slate-600">Date & Time</label>

              <p-datepicker
                [(ngModel)]="dateTime"
                [showIcon]="true"
                [showTime]="true"
                appendTo="body"
                hourFormat="12"
                inputId="dt"
                placeholder="Pick date & time"
                class="w-full"
              ></p-datepicker>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-3 mt-3">
            <div class="flex flex-col gap-2 w-full">
              <label class="text-sm text-slate-600">Duration (minutes)</label>
              <p-inputNumber
                [(ngModel)]="durationMin"
                [useGrouping]="false"
                [min]="10"
                [max]="600"
                [placeholder]="'e.g. 90'"
                class="w-full"
              />
            </div>
            <div class="flex flex-col gap-2">
              <label class="text-sm text-slate-600">Total Marks</label>
              <p-inputNumber
                [(ngModel)]="totalMarks"
                [useGrouping]="false"
                [min]="1"
                [max]="500"
                [placeholder]="'e.g. 100'"
                class="w-full"
              />
            </div>
          </div>

          <div class="flex flex-col gap-2 mt-3">
            <label class="text-sm text-slate-600">Instructions</label>
            <textarea
              pInputTextarea
              autoResize="true"
              [(ngModel)]="instructions"
              rows="3"
              placeholder="Write instructions for students…"
              class="w-full"
            ></textarea>
          </div>

          <p-divider></p-divider>

          <!-- upload -->
          <div class="flex flex-col gap-2">
            <label class="text-sm text-slate-600"
              >Upload Question Paper (optional)</label
            >
            <p-fileUpload
              mode="advanced"
              [customUpload]="true"
              (uploadHandler)="onPaperUpload($event)"
              [multiple]="false"
              [maxFileSize]="50_000_000"
              chooseLabel="Attach"
              uploadLabel="Add"
              cancelLabel="Clear"
              accept=".pdf,.docx,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document"
              [disabled]="uploading"
              [styleClass]="'w-full'"
            ></p-fileUpload>

            <div
              *ngIf="paperFile"
              class="flex items-center justify-between border rounded-md px-3 py-2 bg-slate-50"
            >
              <div class="truncate">
                <i class="pi pi-file mr-2"></i>{{ paperFile.name }}
              </div>
              <button
                pButton
                class="p-button-text p-button-danger"
                (click)="removePaper()"
                label="Remove"
              ></button>
            </div>
          </div>

          <p-divider class="my-4"></p-divider>

          <div class="flex justify-end gap-2">
            <button
              pButton
              class="p-button-text"
              label="Reset"
              (click)="reset()"
              [disabled]="saving"
            ></button>
            <button
              pButton
              label="Create Exam"
              icon="pi pi-check"
              (click)="create()"
              [disabled]="!valid || saving"
            ></button>
          </div>
        </p-card>
      </div>

      <!-- RIGHT: Preview -->
      <div
        class="flex flex-col h-full min-h-0 border border-slate-200 rounded-xl bg-white overflow-hidden"
      >
        <div class="flex-1 min-h-0 overflow-auto p-4">
          <div class="text-slate-800">
            <div class="text-lg font-semibold mb-1">
              {{ title || "Untitled exam" }}
            </div>
            <div class="text-slate-600 mb-3">
              <!-- <span class="mr-3"><i class="pi pi-tag mr-1"></i>{{ (examTypes | json) && (examTypes.find(t => t.value === examType)?.label || '—') }}</span>
              <span class="mr-3"><i class="pi pi-globe mr-1"></i>{{ modes.find(m => m.value === mode)?.label || '—' }}</span>
              <span class="mr-3"><i class="pi pi-calendar mr-1"></i>{{ dateTime ? (dateTime | date:'medium') : '—' }}</span> -->
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
              <div class="p-3 rounded-lg border bg-slate-50">
                <div class="text-xs text-slate-500 mb-1">Duration</div>
                <div class="text-base font-medium">
                  {{ durationMin || "—" }} min
                </div>
              </div>
              <div class="p-3 rounded-lg border bg-slate-50">
                <div class="text-xs text-slate-500 mb-1">Total Marks</div>
                <div class="text-base font-medium">{{ totalMarks || "—" }}</div>
              </div>
            </div>

            <div class="mb-4">
              <div class="text-xs text-slate-500 mb-1">Instructions</div>
              <div class="whitespace-pre-wrap">{{ instructions || "—" }}</div>
            </div>

            <div class="border-t pt-3">
              <div class="text-xs text-slate-500 mb-1">Attachments</div>
              <div
                *ngIf="paperFile; else nofile"
                class="flex items-center gap-2"
              >
                <i class="pi pi-file"></i> {{ paperFile.name }}
              </div>
              <ng-template #nofile>
                <div class="text-slate-400">None</div>
              </ng-template>
            </div>
          </div>
        </div>

        <div
          class="shrink-0 border-t border-slate-200 p-3 bg-slate-50 flex justify-end"
        >
          <button
            pButton
            label="Create Exam"
            icon="pi pi-check"
            (click)="create()"
            [disabled]="!valid || saving"
          ></button>
        </div>
      </div>
    </div>
  </div>
</div>
